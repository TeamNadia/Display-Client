<!DOCTYPE html>
<html lang="en">
<head>
  <title>Music TV</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  
  <style>
    body
    {
      padding-top: 20px;
    }
    #ScreenName
    {
      font-weight: bold;
    }
    #TrackListingTable
    {
      border-width: 0;
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <div class="col-sm-2">
      <h3 class="text-center">Welcome to <span id="ScreenLocation"></span></h3>
      <br>
      Your screen is <span id="ScreenName"></span>.
      <br>
      Use the PIN <span id="ScreenPIN"></span> to control this screen.
      <br>
      <table id="TrackListingTable"></table>
    </div>
    <div class="col-sm-10">
      <div class="embed-responsive embed-responsive-16by9"> <!-- sets the aspect ratio of the video-->
        <!-- <iframe class="embed-responsive-item" src="http://www.youtube.com/embed/ePbKGoIGAXY"></iframe> -->
        <div id="player"></div>
      </div>
    </div>
  </div>
</div>

<!-- Load the JavaScript at the bottom of the page so that it loads faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.getUrlParam.js"></script>
<!--<script src="https://youtube.com/iframe_api"></script>-->
<script>
  var screenId = $(document).getUrlParam("screen");
  
  var tag = document.createElement('script');
  tag.src = "https://youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  
  var player;
  function onYouTubeIframeAPIReady()
  {    
    player = new YT.Player('player', 
    {
      height:   '100%',
      width:    '100%',
      videoId:  '',
      events:
      {
        'onReady':        onPlayerReady,
        'onStateChange':  onPlayerStateChange
      }
    });
  }
  
  function onPlayerReady(event)
  {
    if ($("input.hiddenVideoId")[0])
    {
      alert("Found ");
      loadVideo(event);
    }  
    else
    {
      console.log("LOL");
      setTimeout(onPlayerReady, 500, event);
    }
  }
  
  var done = false;
  function onPlayerStateChange(event)
  {
    if (event.data == YT.PlayerState.ENDED)
    {
      loadVideo(event);
    }
  }
  
  function loadVideo(event)
  {
    event.target.clearVideo();
    
    var videoId = $(".hiddenVideoId:first").attr("value");
    alert(videoId);
    
    $.get("/Server/geturl.php?screen=" + screenId + "&id=" + videoId, function(data)
    {
      event.target.cueVideoByUrl(
        {
          mediaContentUrl: data
        }
      );
      
      event.target.playVideo();
    });
  }
</script>
<script>
  var isUpdatingTrackListing = false;
    
  function updateTrackListing()
  {
    if (isUpdatingTrackListing == true)
      return;
      
    isUpdatingTrackListing = true;
    
    $.get("/Server/getsongs.php?screen=" + screenId, function(data)
    {
      var obj = JSON.parse(data);
      var i;
      var table = $("#TrackListingTable");
      var newTableHtml = "";
      for (i = 0; i < obj.length; i++)
      {
        newTableHtml += '<tr><td><img src="' + obj[i]['thumbnail'] + '"></td><td><span style="font-weight: bold;">' + obj[i]['artist']
        + '</span><br>' + obj[i]['track'] + '</td><td><input type="hidden" class="hiddenVideoId" value="' + obj[i]['id'] + '"></td></tr>';
      }
      
      if (newTableHtml != table.html())
      {
        table.html(newTableHtml);
      }
      
      isUpdatingTrackListing = false;
    });
  }
  
  $.get("/Server/getscreens.php?showpin=1", function(data)
  {
    var obj = JSON.parse(data);
    var i, screenData;
    for (i = 0; i < obj.length; i++)
    {
      if (obj[i]['id'] == screenId)
      {
        screenData = obj[i];
      }
    }
    
    $("#ScreenName").html(screenData['name']);
    $("#ScreenLocation").html(screenData['location']);
    $("#ScreenPIN").html(screenData['pin']);
    
    setInterval(updateTrackListing, 2000);
  });
  
  
</script>
</body>
</html>
